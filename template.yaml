AWSTemplateFormatVersion: "2010-09-09"
Description: Discord Webhook Forwarder for CloudWatch Alarms (Python 3.12)

Parameters:
  DiscordWebhookUrl:
    Type: String
    NoEcho: true
    Description: Discord webhook URL

Globals:
  Function:
    Runtime: python3.12
    Timeout: 15
    MemorySize: 256
    Architectures:
      - x86_64
    Tracing: Active

Resources:
  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${AWS::StackName}-cloudwatch-alerts"
      DisplayName: "CloudWatch Alerts"

  DiscordWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: discord_webhook_lambda.handler.lambda_handler
      Description: Forwards CloudWatch alarm notifications from SNS to Discord webhook
      Environment:
        Variables:
          DISCORD_WEBHOOK_URL: !Ref DiscordWebhookUrl
      Events:
        AlarmSNSEvent:
          Type: SNS
          Properties:
            Topic: !Ref AlarmTopic
    Metadata:
      BuildMethod: python3.12

Outputs:
  FunctionName:
    Description: Lambda function name
    Value: !Ref DiscordWebhookFunction
  SnsTopicArn:
    Description: SNS Topic ARN to use in CloudWatch Alarms
    Value: !Ref AlarmTopic
